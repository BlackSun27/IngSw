from flask import Blueprint, jsonify, request
from controller.gestionale_controller import GestionaleController
from database import get_db

gestionale_bp = Blueprint("gestionale", __name__, url_prefix="/api/gestionale")
db = next(get_db())
controller = GestionaleController(db)

@gestionale_bp.route("impiegati", methods=["GET"])
def get_impiegati():
    impiegati = controller.get_impiegati_db()
    return jsonify([imp.to.dict] for imp in impiegati)

@gestionale_bp.route("/laboratori", methods=["GET"])
def get_laboratori():
    laboratori = controller.get_laboratori_db()
    return jsonify([lab.to.dict] for lab in laboratori)

@gestionale_bp.route("/promozioni", methods=["GET"])
def get_promozioni():
    promozioni = controller.get_promozioni_db()
    return jsonify([prom.to.dict] for prom in promozioni)

@gestionale_bp.route("/progetti", methods=["GET"])
def get_progetti():
    progetti = controller.get_progetti_db()
    return jsonify([prog.to.dict] for prog in progetti)

from flask import Blueprint, request, jsonify
from controller.impiegato_controller import controller
from database import get_db

impiegato_bp = Blueprint("impiegato", __name__, url_prefix="/api/impiegati")

db = next(get_db())

@impiegato_bp.route("/", methods=["POST"])
def aggiungi_impiegato():
    data = request.json
    try:
        controller.aggiungi_impiegato(
            data["cf"], data["nome"], data["cognome"], data["datanascita"], data["merito"],
            data["codicecon"], data["dataassunzione"], data["categoria"], data["salario"]
        )
        return jsonify({"message": "Impiegato aggiunto con successo"}), 201
    except Exception as e:
        return jsonify({"error": str(e)}), 400

@impiegato_bp.route("/<string:cf>", methods=["DELETE"])
def rimuovi_impiegato(cf):
    try:
        controller.rimuovi_impiegato(
            cf
        )
        return jsonify({"message": "Impiegato rimosso con successo"}), 200
    except Exception as e:
        return jsonify({"error":str(e)}), 400
    
@impiegato_bp.route("/<string:cf>/promuovi", methods = ["PATCH"])
def promuovi_impiegato(cf):
    data = request.json
    try:
        controller.promuovi_impiegato(cf, data["merito"])
        return jsonify({"message": f"Impiegato con CF {cf} promosso"}), 200
    except Exception as e:
        return jsonify({"error": str(e)}), 400
    
@impiegato_bp.route("<string:cf>/laboratori", methods=["GET"])
def carica_afferenze(cf):
    try:
        laboratori = controller.carica_afferenze(cf)
        return jsonify(laboratori), 200
    except Exception as e:
        return jsonify({"error": str(e)}), 400

